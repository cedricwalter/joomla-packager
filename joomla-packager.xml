<?xml version="1.0"?>
<!--
/**
 * Copyright (C) 2012-2013 CÃ©dric Walter - www.waltercedric.com  - All Rights Reserved
 * GNU/GPL v3.0
 */
 -->
<project name="joomla-packager" default="build" basedir=".">

    <property name="filename" value="pkg_${itsShortID}_${joomlaID}_${itsVersion}.zip"/>

    <property name="delivery.dir" value="${temp}\${itsShortID}_${itsVersion}"/>
    <property name="packages.dir" value="${temp}\pkg_${itsShortID}_${joomlaID}_${itsVersion}"/>

    <property name="delivery.file" value="${delivery.dir}/../${filename}"/>

    <target name="build" description="build the package" depends="clean">
        <mkdir dir="${packages.dir}"/>
        <echo message="Running build.xml. Assembling"/>
        <phingcall target="doComponents"/>
        <phingcall target="doPlugins"/>
        <phingcall target="doModules"/>
        <phingcall target="doLibraries"/>
        <phingcall target="doCreateManifest"/>
        <phingcall target="doCreateRelease"/>
    </target>

    <target name="doComponents">
        <foreach list="${itsComponents}" param="componentShortID" target="doComponent"/>
    </target>
    <target name="doPlugins">
        <foreach list="${itsContentPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="content"/>
        </foreach>
        <foreach list="${itsAuthenticationPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="authentication"/>
        </foreach>
        <foreach list="${itsCaptchaPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="captcha"/>
        </foreach>
        <foreach list="${itsEditorsPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="editors"/>
        </foreach>
        <foreach list="${itsEditorsXtdPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="editors-xtd"/>
        </foreach>
        <foreach list="${itsExtensionPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="extension"/>
        </foreach>
        <foreach list="${itsFinderPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="finder"/>
        </foreach>
        <foreach list="${itsQuickiconPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="quickicon"/>
        </foreach>
        <foreach list="${itsSearchPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="search"/>
        </foreach>
        <foreach list="${itsSystemPlugins}" param="pluginID" target="doPlugin">
            <property name="type" value="system"/>
        </foreach>
        <foreach list="${itsUserPlugins}" param="pluginID" target="doPlugin" >
            <property name="type" value="user"/>
        </foreach>
    </target>
    <target name="doModules">
        <foreach list="${itsModules}" param="moduleID" target="doModule"/>
    </target>
    <target name="doLibraries">
        <foreach list="${itsLibraries}" param="libraryID" target="doLibrary"/>
    </target>

    <target name="clean">
        <echo message="Running Cleaning"/>
        <phingcall target="deleteDirIfExist">
            <param name="dir" value="${delivery.dir}"  />
        </phingcall>
        <delete file="${delivery.file}"/>
    </target>

    <target name="doCreateRelease">
        <echo message="creating ${delivery.file}"/>
        <zip destfile="${delivery.file}">
            <fileset dir="${packages.dir}">
                <include name="*.zip"/>
                <include name="pkg_${itsShortID}.xml"/>
            </fileset>
        </zip>
    </target>

    <target name="doCreateManifest">
        <echo message="creating pkg_${itsShortID}.xml"/>
<!--
        <echo file="${packages.dir}/pkg_${itsShortID}.xml" append="true">
           ideally generate this file with a template
                   </echo>
        <copy file="pkg_${itsShortID}.xml" todir="${packages.dir}/" overwrite="true"/> -->
        <copy file="${manifestLocation}" todir="${packages.dir}/" overwrite="true"/>
    </target>

    <target name="doLibrary">
        <echo message="preparing ${itsLibraries}"/>
        <copy todir="${delivery.dir}/libraries/${itsLibraries}" overwrite="true">
            <fileset dir="./libraries/${libraryID}" includes="**/*"></fileset>
        </copy>
        <echo message="packaging ${itsLibraries}"/>
        <zip destfile="${packages.dir}/lib_${libraryID}.zip" basedir="${delivery.dir}/libraries/${libraryID}"/>
    </target>

    <target name="doComponent">
        <property name="componentID" value="com_${componentShortID}"/>

        <property name="delivery.base" value="${delivery.dir}/${componentID}/"/>
        <property name="delivery.admin" value="${delivery.base}/administrator/components/${componentID}"/>
        <property name="delivery.site" value="${delivery.base}/components/${componentID}"/>
        <property name="base.admin" value="./administrator/components/${componentID}"/>
        <property name="base.site" value="./components/${componentID}"/>

        <echo message="preparing ${componentID}"/>

        <!-- Optional Languages -->
        <phingcall target="copyAdminLanguages">
            <property name="file" value="${componentID}.ini"/>
            <property name="to" value="${delivery.base}/administrator/language/"/>
        </phingcall>
        <phingcall target="copyComponentLanguages">
            <property name="file" value="${componentID}.ini"/>
            <property name="to" value="${delivery.base}/language/"/>
        </phingcall>

        <!-- Optional Media -->
        <phingcall target="copyIfDirExist">
            <property name="from" value="./media/${componentID}"/>
            <property name="to" value="${delivery.base}/media/${componentID}"/>
        </phingcall>

        <!-- Frontend -->
        <copy todir="${delivery.site}" overwrite="true">
            <fileset dir="${base.site}" includes="**/*.*"></fileset>
        </copy>
        <!-- Backend -->
        <copy todir="${delivery.admin}" overwrite="true">
            <fileset dir="${base.admin}" includes="**/*.*"></fileset>
        </copy>

        <move file="${delivery.admin}/${componentShortID}.xml" tofile="${delivery.base}/${componentShortID}.xml" overwrite="true"/>

        <echo message="packaging ${componentID}"/>
        <zip destfile="${packages.dir}/${componentID}.zip" basedir="${delivery.dir}/${componentID}">
            <fileset dir="${delivery.dir}/${componentID}" includes="**/*"/>
        </zip>
    </target>


    <target name="doPlugin">
        <echo message="preparing plugin ${pluginID} of type ${type}"/>

        <!-- step 1-->
        <copy todir="${delivery.dir}/plugins/${type}" overwrite="true">
            <fileset dir="./plugins/${type}/${pluginID}" includes="**/*.*"></fileset>
        </copy>

        <!-- Optional Media -->
        <phingcall target="copyIfDirExist">
            <property name="from" value="./media/plg_${type}_${pluginID}"/>
            <property name="to" value="${delivery.dir}/plugins/${type}/plg_${type}_${pluginID}"/>
        </phingcall>

        <!-- Optional Languages -->
        <!-- are copied at step 1-->

        <echo message="packaging plugin ${pluginID} of type ${type}"/>
        <zip destfile="${packages.dir}/plg_${type}_${pluginID}.zip" basedir="${delivery.dir}/plugins/${type}">
            <fileset dir="${delivery.dir}/plugins/${type}" includes="**/*"/>
        </zip>
    </target>


    <target name="doModule">
        <echo message="preparing ${moduleID}"/>
        <copy todir="${delivery.dir}/modules/${moduleID}" overwrite="true">
            <fileset dir="./modules/${moduleID}" includes="**/*.*"></fileset>
        </copy>

        <!-- Optional Languages -->
        <phingcall target="copyModuleLanguages">
            <property name="file" value="${moduleID}.ini"/>
            <property name="to" value="${delivery.dir}/modules/${moduleID}"/>
        </phingcall>
        <phingcall target="copyModuleLanguages">
            <property name="file" value="${moduleID}.sys.ini"/>
            <property name="to" value="${delivery.dir}/modules/${moduleID}"/>
        </phingcall>

        <!-- Optional Media -->
        <phingcall target="copyIfDirExist">
            <property name="from" value="./media/${moduleID}"/>
            <property name="to" value="${delivery.dir}/modules/${moduleID}/${moduleID}"/>
        </phingcall>

        <echo message="packaging ${moduleID}"/>
        <zip destfile="${packages.dir}/${moduleID}.zip" basedir="${delivery.dir}/modules/${moduleID}">
            <fileset dir="${delivery.dir}/modules/${moduleID}" includes="**/*"/>
        </zip>
    </target>


    <!-- TODO use the same pattern directory for both, check what joomla recommend -->
    <target name="copyComponentLanguages">
        <foreach list="${itsLanguages}" param="language" target="copyLanguage">
            <property name="file" value="./language/${language}/${language}.${file}"/>
            <property name="to" value="${to}/${language}"/>
        </foreach>
    </target>

    <target name="copyModuleLanguages">
        <foreach list="${itsLanguages}" param="language" target="copyLanguage">
            <property name="file" value="./language/${language}/${language}.${file}"/>
            <property name="to" value="${to}"/>
        </foreach>
    </target>


    <target name="copyAdminLanguages">
        <foreach list="${itsLanguages}" param="language" target="copyLanguage">
            <property name="file" value="./administrator/language/${language}/${language}.${file}"/>
            <property name="to" value="${delivery.base}/administrator/language/${itsLanguages}"/>
        </foreach>
    </target>

    <target name="copyLanguage">
        <phingcall target="copyIfFileExist">
            <property name="file" value="${file}"/>
            <property name="to" value="${to}"/>
        </phingcall>
    </target>

    <target name="copyIfDirExist">
        <if>
            <available file='${from}' type='dir'/>
            <then>
                <copy todir="${to}" overwrite="true">
                    <fileset dir="${from}" includes="**/*.*"></fileset>
                </copy>
            </then>
        </if>
    </target>

    <target name="deleteDirIfExist">
        <if>
            <available file='${dir}' type='dir'/>
            <then>
                <delete dir="${dir}" includeemptydirs="true" verbose="true" failonerror="true"/>
            </then>
        </if>
    </target>

    <target name="copyIfFileExist">
        <echo message="Copy if file exist ${file} to ${to}" />
        <if>
            <available file='${file}' type='file'/>
            <then>
                <copy file="${file}" todir="${to}" overwrite="true"/>
            </then>
        </if>
    </target>

</project>
